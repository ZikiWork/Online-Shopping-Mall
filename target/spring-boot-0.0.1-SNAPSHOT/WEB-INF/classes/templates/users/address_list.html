<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8"></meta>
<title>地址管理</title>
<link rel="stylesheet" type="text/css" th:href="@{/css/index.css}" />
<script type="text/javascript" th:src="@{/js/jquery-2.0.3.js}"></script>
<script type="text/javascript" th:src="@{/js/address.js}"></script>
<script type="text/javascript" th:src="@{/js/template.js}"></script>
<script type="text/javascript">
	$(function() {
		for (var i = 0; i < provinceList.length; i++) {
			var option = $("<option>" + provinceList[i].name + "</option>");
			option.prop("cities", provinceList[i].cityList);
			$("#province").append(option);
		}
		
		changeProvince();
		changeCity();
		$("#province").on("change", changeProvince);
		$("#city").on("change", changeCity);
		$("#post").on("click", post); /* ajaxpost请求将数据返回服务器*/
		getJSON();//得到后台数据！

	});
	/* 地区选择！ */
	function changeProvince() {
		$("#city").empty();
		var cities = $("#province").find("option:selected").prop("cities");
		for (var i = 0; i < cities.length; i++) {
			var option = $("<option>" + cities[i].name + "</option>");
			option.prop("area", cities[i].areaList);
			$("#city").append(option);
		}
		changeCity();
	}
	function changeCity() {
		$("#area").empty();
		var area = $("#city").find("option:selected").prop("area");
		for (var i = 0; i < area.length; i++) {
			var option = $("<option>" + area[i] + "</option>");
			$("#area").append(option);
		}
	}
	/* 地区选择结束！ */

	
	/* ajax post请求将数据发送到服务器 */
	function post() {

		if ($("#updateId").val() == "") {//辨别修改或者增加功能！

			if ($("input[type='checkbox']").prop("checked") == true) { /* 判断地址是否选为默认地址  */
				$("#isdef").val("1");
			}
			/* 将界面输入的数据转为JSON数据格式*/
			let address = {
				"reciever" : $("#reciever").val(),
				"province" : $("#province").val(),
				"city" : $("#city").val(),
				"area" : $("#area").val(),
				"street" : $("#street").val(),
				"phone" : $("#phone").val(),
				"telphone" : $("#telphone").val(),
				"zip" : $("#zip").val(),
				"isdef" : $("#isdef").val()

			};
			/* ajax Post请求 发送JSON数据至服务端 */
			$.ajax({
				type : "POST",
				url : "/address/add",
				data : JSON.stringify(address),//转换数据为JSON格式的字符串！！！
				contentType : "application/json",
				success : function(address) {
					getJSON();//查询所有地址！
					/*输入地址 确定后 将数据清空！    */
					$("#reciever").val("");
					$("#street").val("");
					$("#phone").val("");
					$("#telphone").val("");
					$("#zip").val("");
					$("#isdef").val("");
					/* 清空结束 */
					//$("#template").empty();//清空 所有收货地址信息（否则会重复添加之前的信息到指定位置！）
				}
			});
			/* 以上为增加 */
			/* 以下为修改 */
		} else {

			if ($("input[type='checkbox']").prop("checked") == true) { /* 判断地址是否选为默认地址  */ /*prop找属性*/
				$("#isdef").val("1");
			}
			/* 将界面输入修改的数据转为JSON数据格式*/
			let address = {
				"id" : $("#updateId").val(),//包括ID!
				"reciever" : $("#reciever").val(),
				"province" : $("#province").val(),
				"city" : $("#city").val(),
				"area" : $("#area").val(),
				"street" : $("#street").val(),
				"phone" : $("#phone").val(),
				"telphone" : $("#telphone").val(),
				"zip" : $("#zip").val(),
				"isdef" : $("#isdef").val()

			};
			/* ajax Post请求 发送JSON数据至服务端 */
			$.ajax({
				type : "POST",
				url : "/address/updateAddress",
				data : JSON.stringify(address),//转换数据为JSON格式的字符串！！！
				contentType : "application/json",
				success : function(address) {
					getJSON();

					/*修改地址 确定后      将数据清空！    */
					$("#updateId").val("")
					$("#reciever").val("");
					$("#street").val("");
					$("#phone").val("");
					$("#telphone").val("");
					$("#zip").val("");
					$("#isdef").val("");
					/* 清空结束 */
					//$("#template").empty();//清空 所有收货地址信息（否则会重复添加之前的信息到指定位置！）
				}
			});
		}
		/* 修改结束 */

	}

	/* ajax get请求获取数据  查询收获地址*/
	function getJSON() {

		$.getJSON("/address/getaddress", function(addresses) {

			$("#template").empty();//清空 所有 收货地址信息（否则会重复添加之前的信息到指定位置！）

			let ht = template('tp', {
				"list" : addresses
			});
			$("#template").append(ht);
		})
	}
	/* ajax 查询收获地址结束*/

	/* 删除收货地址 */
	function del(id) {
		if (confirm("是否确认删除？")) {
			$.ajax({
				type : "GET",
				url : "/address/deleteaddress/" + id,
				success : function(del) {
					console.log(del);
					getJSON();
				}
			});
		}
	}
	/* 修改收货地址 */
	function update(id) {
		$.ajax({
			type : "get",
			url : "/address/updateaddress/" + id,
			dataType : "JSON",
			success : function(address) {
				console.log(address);
				/* 得到修改地址的ID 以便判断 是作修改还是增加！！！ */
				$("#updateId").val(address.id);
				/* 将修改地址显示到下面修改 */
				$("#reciever").val(address.reciever);
				$("#street").val(address.street);
				$("#phone").val(address.phone);
				$("#telphone").val(address.telphone);
				$("#zip").val(address.zip);
			}
		});

	}

	/* 修改默认状态： */
	function updateIsdef(id, isdef) {//直接传入需要的两个参数！isdef 直接给定值
		$.ajax({
			type : "GET",
			url : "/address/updateIsdef/" + id + "/" + isdef,
			success : function(updateIsdef) {
				console.log(updateIsdef);
				getJSON();
			}
		});

	}
</script>
<!-- template模板 加载数据！ -->
<script id="tp" type="text/html"> 
										{{each list as address }}
										<tr>
											<td>{{address.reciever}}</td>
											<td>{{address.province}} {{address.city}} {{address.area}}</td>
											<td>{{address.street}}</td>
											<td>{{address.phone}}/{{address.telphone}}</td>
											<td>{{address.zip}}</td>
											<td><a class="blue" href='javascript:void(0)' onclick="update({{address.id}})">修改</a>|
												<a class="blue" href="javascript:void(0)" onclick="del({{address.id}})">删除</a>|
											{{if address.isdef==1}}
												<a class="red2" >默认地址</a>
											{{/if}}
											{{if address.isdef==0}}
												<a class="blue" onclick="updateIsdef({{address.id}},1)"  >设为默认</a>
											{{/if}}</td>
										</tr>
    									 {{/each}}
</script>
<!-- template模板  -->
</head>
<body class="index">
	<div class="ucenter container">
		<div th:replace="~{commons::header}"></div>
		<div th:replace="~{commons::navbar}"></div>
		<div th:replace="~{commons::search}"></div>
		<div class="position">
			您当前的位置： <a href="">首页</a> » <a href="">我的账户</a> » <a href="">地址管理</a>
		</div>
		<div class="wrapper clearfix">
			<div th:replace="~{users/commons::left}"></div>
			<div class="main f_r">
				<div class='tabs'>
					<div class="uc_title m_10 tabs_menu">
						<label class="current node"><span>地址管理</span></label>
					</div>
					<div class='tabs_content'>
						<div id="address_list" class="form_content m_10 node">
							<div class="uc_title2 m_10">
								<strong>已保存的有效地址</strong>
							</div>
							<table class="list_table" width="100%" cellpadding="0"
								cellspacing="0">
								<col width="120px" />
								<col width="120px" />
								<col width="120px" />
								<col width="120px" />
								<col width="120px" />
								<col />
								<thead>
									<tr>
										<th>收货人</th>
										<th>所在地区</th>
										<th>街道地址</th>
										<th>电话/手机</th>
										<th>邮编</th>
										<th>操作</th>
									</tr>
								</thead>
								<!-- 显示地址 -->
								<tbody id=template>

								</tbody>
								<!-- 显示地址结束 -->
							</table>
						</div>
					</div>
				</div>

				<!--表单修改-->
				<div class="orange_box" id='address_form'>
					<!-- <form th:action='@{/address_add}' method='post' name='form'> -->
					<!-- 添加隐藏表单：判断功能为增加还是修改！ -->
					<input id="updateId" type="text" value="" />
					<table class="form_table" width="100%" cellpadding="0"
						cellspacing="0">
						<col width="120px" />
						<col />
						<caption>收货地址</caption>
						<tr>
							<th><span class="red">*</span> 收货人姓名：</th>
							<td><input name='reciever' id="reciever" class="normal"
								type="text" /><label>收货人真实姓名，方便快递公司联系。</label></td>
						</tr>
						<!-- 地区选择！ -->
						<tr>
							<th><span class="red">*</span> 所在地区：</th>
							<td><select name="province" id="province"></select> <select
								name="city" id="city"></select> <select name="AREA" id="area"></select></td>
						</tr>

						<tr>
							<th><span class="red">*</span> 街道地区：</th>
							<td><input name='street' id="street" class="normal"
								type="text" /><label>真实详细收货地址，方便快递公司联系。</label></td>
						</tr>
						<tr>
							<th>邮政编码：</th>
							<td><input name='zip' id="zip" class="normal" type="text" /><label>邮政编码,如250000。</label></td>
						</tr>
						<tr>
							<th>电话号码：</th>
							<td><input name='phone' id="phone" class="normal"
								type="text" /><label>电话号码,如010-12345688。</label></td>
						</tr>
						<tr>
							<th>手机号码：</th>
							<td><input name='telphone' id="telphone" class="normal"
								type="text" /><label>手机号码，如：13588888888</label></td>
						</tr>
						<tr>
							<th>设为默认：</th>
							<td><label><input name='address.isdefault'
									id="isdef" type='checkbox' value='0'></label></td>
						</tr>
						<tr>
							<th></th>
							<td><label class="btn"><input type="button"
									id="post" value="保存" /></label> <label class="btn"><input
									type="reset" value="取消" /></label></td>
						</tr>
					</table>
					<!-- </form> -->
				</div>
			</div>
		</div>
		<div th:replace="~{commons::help}"></div>
		<div th:replace="~{commons::footer}"></div>
	</div>
</body>
</html>
